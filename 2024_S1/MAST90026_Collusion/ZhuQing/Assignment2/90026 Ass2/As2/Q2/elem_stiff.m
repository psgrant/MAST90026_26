function K = elem_stiff(P1, P2, P3, D, quad_order)
j11=P2(1)-P1(1);
j12=P3(1)-P1(1);
j21=P2(2)-P1(2);
j22=P3(2)-P1(2);
detJ=(j11*j22-j12*j21);
K=abs(detJ);
stiff=zeros(3,3);
 if (quad_order == 1)
    stiff(1,1)=((j21-j22)^2+(j12-j11)^2)*(D(P1(1),P1(2))+D(P2(1),P2(2))+D(P3(1),P3(2)))/6;
    stiff(1,2)=(j22*j21-j22^2+j12*j11-j12^2)*(D(P1(1),P1(2))+D(P2(1),P2(2))+D(P3(1),P3(2)))/6;
    stiff(1,3)=(j21*j22-j21^2+j11*j12-j11^2)*(D(P1(1),P1(2))+D(P2(1),P2(2))+D(P3(1),P3(2)))/6;
    stiff(2,1)=(j22*j21-j22^2+j12*j11-j12^2)*(D(P1(1),P1(2))+D(P2(1),P2(2))+D(P3(1),P3(2)))/6;
    stiff(2,2)=(j22^2+j12^2)*(D(P1(1),P1(2))+D(P2(1),P2(2))+D(P3(1),P3(2)))/6;
    stiff(2,3)=(-j22*j21-j12*j11)*(D(P1(1),P1(2))+D(P2(1),P2(2))+D(P3(1),P3(2)))/6;
    stiff(3,1)=(j21*j22-j21^2+j11*j12-j11^2)*(D(P1(1),P1(2))+D(P2(1),P2(2))+D(P3(1),P3(2)))/6;
    stiff(3,2)=(-j22*j21-j12*j11)*(D(P1(1),P1(2))+D(P2(1),P2(2))+D(P3(1),P3(2)))/6;
    stiff(3,3)=(j21^2+j11^2)*(D(P1(1),P1(2))+D(P2(1),P2(2))+D(P3(1),P3(2)))/6;
    stiff=stiff*K/(detJ*detJ);
    K=stiff;
 else
    stiff(1,1)=((j21-j22)^2+(j12-j11)^2)*(D((P1(1)+P2(1))/2,(P1(2)+P2(2))/2)+D((P2(1)+P3(1))/2,(P2(2)+P3(2))/2) ...
        +D((P1(1)+P3(1))/2,(P1(2)+P3(2))/2));
    stiff(1,2)=(j22*j21-j22^2+j12*j11-j12^2)*(D((P1(1)+P2(1))/2,(P1(2)+P2(2))/2)+D((P2(1)+P3(1))/2,(P2(2)+P3(2))/2) ...
        +D((P1(1)+P3(1))/2,(P1(2)+P3(2))/2));
    stiff(1,3)=(j21*j22-j21^2+j11*j12-j11^2)*(D((P1(1)+P2(1))/2,(P1(2)+P2(2))/2)+D((P2(1)+P3(1))/2,(P2(2)+P3(2))/2) ...
        +D((P1(1)+P3(1))/2,(P1(2)+P3(2))/2));
    stiff(2,1)=(j22*j21-j22^2+j12*j11-j12^2)*(D((P1(1)+P2(1))/2,(P1(2)+P2(2))/2)+D((P2(1)+P3(1))/2,(P2(2)+P3(2))/2) ...
        +D((P1(1)+P3(1))/2,(P1(2)+P3(2))/2));
    stiff(2,2)=(j22^2+j12^2)*(D((P1(1)+P2(1))/2,(P1(2)+P2(2))/2)+D((P2(1)+P3(1))/2,(P2(2)+P3(2))/2) ...
        +D((P1(1)+P3(1))/2,(P1(2)+P3(2))/2));
    stiff(2,3)=(-j22*j21-j12*j11)*(D((P1(1)+P2(1))/2,(P1(2)+P2(2))/2)+D((P2(1)+P3(1))/2,(P2(2)+P3(2))/2) ...
        +D((P1(1)+P3(1))/2,(P1(2)+P3(2))/2));
    stiff(3,1)=(j21*j22-j21^2+j11*j12-j11^2)*(D((P1(1)+P2(1))/2,(P1(2)+P2(2))/2)+D((P2(1)+P3(1))/2,(P2(2)+P3(2))/2) ...
        +D((P1(1)+P3(1))/2,(P1(2)+P3(2))/2));
    stiff(3,2)=(-j22*j21-j12*j11)*(D((P1(1)+P2(1))/2,(P1(2)+P2(2))/2)+D((P2(1)+P3(1))/2,(P2(2)+P3(2))/2) ...
        +D((P1(1)+P3(1))/2,(P1(2)+P3(2))/2));
    stiff(3,3)=(j21^2+j11^2)*(D((P1(1)+P2(1))/2,(P1(2)+P2(2))/2)+D((P2(1)+P3(1))/2,(P2(2)+P3(2))/2) ...
        +D((P1(1)+P3(1))/2,(P1(2)+P3(2))/2));
    stiff=stiff*K/(6*detJ*detJ);
    K=stiff;
 end
end